name: Perf Nightly

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

jobs:
  bench-nightly:
    name: JMH Nightly (JDK 25)
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
          cache: maven

      - name: Build benchmark uber-jar
        run: mvn -B -q clean package -Pbench -DskipTests

      - name: Run nightly benchmark suite
        run: |
          java --add-modules jdk.incubator.vector -jar target/benchmarks.jar ".*(TransformComposeBenchmark|Affine4fBenchmark|FrustumCullingBenchmark|GpuPackingBenchmark|QuatCompressionBenchmark|GpuLayoutBenchmark|SkinningKernelBenchmark|MeshMathBenchmark|StdLayoutBenchmark|ReductionBenchmark).*" \
            -f 2 -wi 5 -i 8 -w 250ms -r 250ms -t 1 \
            -rf csv -rff target/jmh-nightly.csv

      - name: Benchmark regression check (if nightly baseline exists)
        run: |
          if [ -f benchmarks/baselines/ci-jdk25-nightly.csv ]; then
            ./scripts/bench-compare.sh benchmarks/baselines/ci-jdk25-nightly.csv target/jmh-nightly.csv 10 18 18
          else
            echo "No nightly baseline found at benchmarks/baselines/ci-jdk25-nightly.csv; skipping regression gate."
          fi

      - name: Upload nightly benchmark result
        uses: actions/upload-artifact@v4
        with:
          name: jmh-nightly-csv
          path: target/jmh-nightly.csv
